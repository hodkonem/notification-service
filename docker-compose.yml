services:
  kafka:
    image: apache/kafka:3.7.0
    container_name: notification-kafka
    restart: unless-stopped
    ports:
      - "${KAFKA_HOST_PORT:-9092}:9092"
    environment:
      # --- KRaft mode ---
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"

      # --- listeners ---
      # 9092  -> host (localhost)
      # 29092 -> docker network (kafka:29092)
      KAFKA_LISTENERS: "PLAINTEXT_HOST://:9092,PLAINTEXT://:29092,CONTROLLER://:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT_HOST://localhost:9092,PLAINTEXT://kafka:29092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"

      # --- single-node dev settings ---
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

    volumes:
      - notification_kafka_data:/var/lib/kafka/data
    networks:
      - notif-net

  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: notification-mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_HTTP_PORT:-8025}:8025"
    networks:
      - notif-net

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: notification-kafka-ui
    restart: unless-stopped
    depends_on:
      - kafka
    ports:
      - "${KAFKA_UI_PORT:-8089}:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
    networks:
      - notif-net

  kafka-tools:
    image: confluentinc/cp-kafka:7.5.0
    container_name: notification-kafka-tools
    depends_on:
      - kafka
    entrypoint: [ "/bin/bash", "-lc", "sleep infinity" ]
    networks:
      - notif-net

volumes:
  notification_kafka_data:

networks:
  notif-net:
    name: notif-net
